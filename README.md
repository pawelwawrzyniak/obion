# obion tassk

## Very brief documentation how to use this project

1. This project is still in progress therefore some pieces will require operator adjustments  
2. Aim of the project is to:  

a. create infrastructure as a code state    -> terraform-state project (COMPLETED)  
b. create infrastructure for rke cluster    -> terraform project (COMPLETED)  
c. create k8s cluster with rks tool         -> terraform/rke-latest examples (COMPLETED)  
Note: rke config is automatically generated by each of the nodes in ASG (workers and controllers) and saved to rke-data S3 busket.  
Ideally this will be moved to parameter store where k8s service could manage scaling of the cluster.  

d. application deployment is done via helm manager  -> helm/chart/voting-app  
Note: application is running however Ingress part is not completed)  
e. application deployment pipeline                  -> helm/chart/jenkins  

## Run project

Terraform v1.1.6  
terraform init|plan|apply|destroy in all terraform projects will deploy Infrastructure  

Helm v3.6.0  
_to deploy voting-app_
> cd helm/chart/voting-app  
> helm upgrade -i voting-app -f values.yaml . --namespace voting-app --create-namespace  
 > helm uninstall --namespace voting-app voting-app  

 ## TODO
- ASG scaling in/out notifications  
- to add dynamic variable in userdata script with tag (https://stackoverflow.com/questions/28643573/how-to-set-an-environment-variable-in-amazon-ec2)  
- ideally change script to a tool which can query aws ec2 by labels and update rke accordingly so old nodes are removed from config  

- change busket rke data to SSM parameters  
- ssh ports https://rancher.com/docs/rke/latest/en/os/#ports  -> adjust SG and ACL wit it
- bastion with statinc EIP  -> plus VPN access
- service running in control plane to watch SSM secret update and if newer than last timestamp update cluster  
- durring deployment bump app chart version up  
- certificates in ELB and application
- ingress RKE to be elevated (not sure why it goes to ingress-nginx namespace only)  